(()=>{"use strict";class t{constructor(){}moveDown(){this.coordinates=this.coordinates.map((t=>{const{row:o}=t;return{...t,row:o+1}}))}moveRight(){this.coordinates=this.coordinates.map((t=>{const{column:o}=t;return{...t,column:o+1}}))}moveLeft(){this.coordinates=this.coordinates.map((t=>{const{column:o}=t;return{...t,column:o-1}}))}validMoveRight(t){return this.coordinates.filter((t=>t.side.includes("right"))).every((o=>{const{row:e,column:i}=o,n=i+1;if(n<=9)return"black"===t[e][n]}))}validMoveLeft(t){return this.coordinates.filter((t=>t.side.includes("left"))).every((o=>{const{row:e,column:i}=o,n=i-1;if(n>=0)return"black"===t[e][n]}))}validMoveDown(t){return 0!==this.coordinates.length&&this.coordinates.filter((t=>t.side.includes("bottom"))).every((o=>{const{row:e,column:i}=o,n=e+1;if(n<=19)return"black"===t[n][i]}))}clearCoordinates(t){this.coordinates=this.coordinates.filter((o=>{const{row:e}=o;return!t.includes(e)}))}determineCoordinatesToClear(t){return this.coordinates.filter((o=>{const{row:e}=o;return t.includes(e)}))}}class o extends t{constructor(){super(),this.coordinates=[{row:0,column:4,side:["top","left"]},{row:0,column:5,side:["top","right"]},{row:1,column:4,side:["bottom","left"]},{row:1,column:5,side:["bottom","right"]}],this.color="yellow"}rotateRight(){}rotateLeft(){}}class e extends t{constructor(){super(),this.coordinates=[{row:0,column:3,side:["top","bottom","left"]},{row:0,column:4,side:["top","bottom"]},{row:0,column:5,side:["top","bottom"]},{row:0,column:6,side:["top","bottom","right"]}],this.anchorPointDirection="left",this.color="orange",this.nextRotationRightMove={left:"top",top:"right",right:"bottom",bottom:"left"},this.nextRotationRightMoveMethod={left:this.calcRotationLeftToTop.bind(this),top:this.calcRotationTopToRight.bind(this),right:this.calcRotationRightToBottom.bind(this),bottom:this.calcRotationBottomToLeft.bind(this)},this.nextRotationLeftMove={left:"bottom",bottom:"right",right:"top",top:"left"},this.nextRotationLeftMoveMethod={left:this.calcRotationLeftToBottom.bind(this),bottom:this.calcRotationBottomToRight.bind(this),right:this.calcRotationRightToTop.bind(this),top:this.calcRotationTopToLeft.bind(this)}}rotateLeft(t){this.validRotateLeft(t)&&(this.coordinates=this.nextRotationLeftMoveMethod[this.anchorPointDirection](),this.anchorPointDirection=this.nextRotationLeftMove[this.anchorPointDirection])}validRotateLeft(t){const o=this.nextRotationLeftMoveMethod[this.anchorPointDirection](),e=o.every((t=>{const{row:o,column:e}=t;return o>=0&&o<=19&&e>=0&&e<=9})),i=o.every((o=>{const{row:e,column:i}=o;return"black"===t[e][i]}));return e&&i}calcRotationLeftToBottom(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({column:e,row:o-i,side:t.side.map((t=>this.nextRotationLeftMove[t]))})))}calcRotationBottomToRight(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({row:o,column:e-i,side:t.side.map((t=>this.nextRotationLeftMove[t]))})))}calcRotationRightToTop(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({column:e,row:o+i,side:t.side.map((t=>this.nextRotationLeftMove[t]))})))}calcRotationTopToLeft(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({row:o,column:e+i,side:t.side.map((t=>this.nextRotationLeftMove[t]))})))}rotateRight(t){this.validRotateRight(t)&&(this.coordinates=this.nextRotationRightMoveMethod[this.anchorPointDirection](),this.anchorPointDirection=this.nextRotationRightMove[this.anchorPointDirection])}validRotateRight(t){const o=this.nextRotationRightMoveMethod[this.anchorPointDirection](),e=o.every((t=>{const{row:o,column:e}=t;return o>=0&&o<=19&&e>=0&&e<=9})),i=o.every((o=>{const{row:e,column:i}=o;return"black"===t[e][i]}));return e&&i}calcRotationLeftToTop(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({column:e,row:o+i,side:t.side.map((t=>this.nextRotationRightMove[t]))})))}calcRotationTopToRight(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({row:o,column:e-i,side:t.side.map((t=>this.nextRotationRightMove[t]))})))}calcRotationRightToBottom(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({column:e,row:o-i,side:t.side.map((t=>this.nextRotationRightMove[t]))})))}calcRotationBottomToLeft(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>({row:o,column:e+i,side:t.side.map((t=>this.nextRotationRightMove[t]))})))}}class i extends t{constructor(){super(),this.coordinates=[{row:0,column:4,side:["left","top"]},{row:1,column:4,side:["left","bottom"]},{row:1,column:5,side:["bottom"]},{row:1,column:6,side:["right","bottom"]}],this.color="blue",this.anchorPointDirection="top",this.nextRotationLeftMove={left:"bottom",bottom:"right",right:"top",top:"left"},this.nextRotationLeftMoveMethod={top:this.calcRotationTopToLeft.bind(this),left:this.calcRotationLeftToBottom.bind(this),bottom:this.calcRotationBottomToRight.bind(this),right:this.calcRotationRightToTop.bind(this)},this.nextRotationRightMove={left:"top",top:"right",right:"bottom",bottom:"left"},this.nextRotationRightMoveMethod={left:this.calcRotationLeftToTop.bind(this),top:this.calcRotationTopToRight.bind(this),right:this.calcRotationRightToBottom.bind(this),bottom:this.calcRotationBottomToLeft.bind(this)}}rotateRight(t){this.validRotateRight(t)&&(this.coordinates=this.nextRotationRightMoveMethod[this.anchorPointDirection](),this.anchorPointDirection=this.nextRotationRightMove[this.anchorPointDirection])}validRotateRight(t){const o=this.nextRotationRightMoveMethod[this.anchorPointDirection](),e=o.every((t=>{const{row:o,column:e}=t;return o>=0&&o<=19&&e>=0&&e<=9})),i=o.every((o=>{const{row:e,column:i}=o;return"black"===t[e][i]}));return e&&i}calcRotationTopToRight(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?i-1:i,r=i>0?1:i;return{side:t.side.map((t=>this.nextRotationRightMove[t])),column:e-r,row:o+n}}))}calcRotationRightToBottom(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?1:i,r=i>0?i-1:i;return{side:t.side.map((t=>this.nextRotationRightMove[t])),column:e-r,row:o-n}}))}calcRotationBottomToLeft(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?i-1:i,r=i>0?1:i;return{side:t.side.map((t=>this.nextRotationRightMove[t])),column:e+r,row:o-n}}))}calcRotationLeftToTop(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?1:i,r=i>0?i-1:i;return{side:t.side.map((t=>this.nextRotationRightMove[t])),column:e+r,row:o+n}}))}rotateLeft(t){this.validRotateLeft(t)&&(this.coordinates=this.nextRotationLeftMoveMethod[this.anchorPointDirection](),this.anchorPointDirection=this.nextRotationLeftMove[this.anchorPointDirection])}validRotateLeft(t){const o=this.nextRotationLeftMoveMethod[this.anchorPointDirection](),e=o.every((t=>{const{row:o,column:e}=t;return o>=0&&o<=19&&e>=0&&e<=9})),i=o.every((o=>{const{row:e,column:i}=o;return"black"===t[e][i]}));return e&&i}calcRotationTopToLeft(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?i-1:i,r=i>0?1:i;return{side:t.side.map((t=>this.nextRotationLeftMove[t])),column:e+r,row:o-n}}))}calcRotationLeftToBottom(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?1:i,r=i>0?i-1:i;return{side:t.side.map((t=>this.nextRotationLeftMove[t])),column:e-r,row:o-n}}))}calcRotationBottomToRight(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?i-1:i,r=i>0?1:i;return{side:t.side.map((t=>this.nextRotationLeftMove[t])),column:e-r,row:o+n}}))}calcRotationRightToTop(){const t=this.coordinates[0],{row:o,column:e}=t;return this.coordinates.map(((t,i)=>{const n=i>0?1:i,r=i>0?i-1:i;return{side:t.side.map((t=>this.nextRotationLeftMove[t])),column:e+r,row:o+n}}))}}class n{constructor(t){const n=[];for(let t=0;t<20;t++){const t=[];for(let o=0;o<10;o++)t.push("black");n.push(t)}this.document=document,this.gamePaused=!1,this.gameBoard=n,this.currentPiece=null,this.droppedPieces=[],this.stage=t,this.gameOver=!1,this.currentScore=0,this.interval=setInterval((()=>this.currentPieceDefaultMove()),500),this.allPieces=[new o,new e,new i]}currentPieceDefaultMove(){this.isCurrentPieceStuck()&&this.checkGameOver(),this.isCurrentPieceStuck()&&this.gameOver&&this.restartGame(document),this.isCurrentPieceStuck()||this.gameOver?this.handleCurrentPieceStuck():(this.clearOldTetrominoPosition(),this.currentPiece.moveDown(),this.updateGrid(),this.render())}pauseGame(){this.gamePaused?(this.interval=setInterval((()=>this.currentPieceDefaultMove()),500),this.gamePaused=!1):(clearInterval(this.interval),this.gamePaused=!0)}render(){this.stage.removeAllChildren(),this.gameBoard.forEach(((t,o)=>{t.forEach(((t,e)=>{const i=new createjs.Shape;i.graphics.beginFill(t).drawRect(30*e,30*o,30,30),this.stage.addChild(i)}))})),this.stage.update()}updateGrid(){this.currentPiece.coordinates.forEach((t=>{const{row:o,column:e}=t;this.gameBoard[o][e]=this.currentPiece.color}))}startGame(){this.createNewPiece()}isCurrentPieceStuck(){return!this.currentPiece.validMoveDown(this.gameBoard)}createNewPiece(){const t=new i;this.currentPiece=t,this.droppedPieces.push(t)}calculateCompletedRows(){const t=[];return this.gameBoard.forEach(((o,e)=>{o.every((t=>"black"!==t))&&t.push(e)})),t}calculateScore(){const t=this.calculateCompletedRows().length,o=t<4?100*t:200*t;this.currentScore+=o}clearGameBoardRows(t){this.droppedPieces.forEach((o=>{const e=o.determineCoordinatesToClear(t);for(o.clearCoordinates(t),e.forEach((t=>{const{row:o,column:e}=t;this.gameBoard[o][e]="black"}));o.validMoveDown(this.gameBoard);)o.coordinates.forEach((t=>{const{row:o,column:e}=t;this.gameBoard[o][e]="black"})),o.moveDown(),o.coordinates.forEach((t=>{const{row:e,column:i}=t;this.gameBoard[e][i]=o.color}))})),this.render()}clearOldTetrominoPosition(){this.currentPiece.coordinates.forEach((t=>{const{row:o,column:e}=t;this.gameBoard[o][e]="black"}))}checkGameOver(){const t=this.currentPiece.coordinates.filter((t=>t.side.includes("top")));for(let o=0;o<t.length;o++){const e=t[o],{row:i}=e;if(0===i){this.gameOver=!0,this.pauseGame();break}}}restartGame(t){if(this.gameOver){this.pauseGame();const o=t.createElement("h1"),e=t.createTextNode("GAME OVER");o.appendChild(e),t.body.appendChild(o);const i=t.createElement("button");return i.innerHTML="RESTART GAME",i.addEventListener("click",(()=>{init(),o.removeChild(e),t.body.removeChild(i)})),void t.body.appendChild(i)}}executeMove(t){39===t.keyCode&&this.currentPiece.validMoveRight(this.gameBoard)?(this.clearOldTetrominoPosition(),this.currentPiece.moveRight()):37===t.keyCode&&this.currentPiece.validMoveLeft(this.gameBoard)?(this.clearOldTetrominoPosition(),this.currentPiece.moveLeft()):40===t.keyCode&&this.currentPiece.validMoveDown(this.gameBoard)?(this.clearOldTetrominoPosition(),this.currentPiece.moveDown()):38===t.keyCode?(this.clearOldTetrominoPosition(),this.currentPiece.rotateRight(this.gameBoard)):88===t.keyCode&&(this.clearOldTetrominoPosition(),this.currentPiece.rotateLeft(this.gameBoard)),this.updateGrid(),this.render()}handleCurrentPieceStuck(){if(!this.isCurrentPieceStuck())return;const t=this.calculateCompletedRows();t.length>0&&(this.calculateScore(),this.clearGameBoardRows(t)),this.checkGameOver(),this.createNewPiece(),this.updateGrid(),setTimeout((()=>{this.render()}),300),console.log(this)}handleKeyPress(t){t.preventDefault(),this.gamePaused||this.executeMove(t)}}let r,s;window.init=()=>{s=new createjs.Stage("tetris"),r=new n(s,document),r.startGame();const t=new createjs.Shape;t.graphics.beginFill("#000000").drawRect(0,0,300,600),s.addChild(t),r.updateGrid(),r.render(),r.calculateScore();const o=document.createElement("h1"),e=document.createTextNode(`Score: ${r.currentScore}`);o.appendChild(e),document.body.appendChild(o);const i=document.createElement("button");i.innerHTML="PAUSE GAME",i.addEventListener("click",(()=>r.pauseGame())),document.body.appendChild(i),r.gameOver&&r.gamePaused||document.addEventListener("keydown",(t=>r.handleKeyPress(t))),console.log(r)},window.onload=init})();